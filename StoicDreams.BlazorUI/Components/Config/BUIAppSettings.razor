@inherits BUICore
@inject IDialogService DialogService
@inject IThemeState ThemeState

<BUIDrawerHeader>App Settings</BUIDrawerHeader>

<BUIDrawerPaper>
	@if (ShowThemeSelector)
	{
		@if (FlipState)
		{
			<MudSelect Label="Select Theme" FullWidth="true" Value="@SelectedId" ValueChanged="(Guid id) => HandleThemeChange(id)">
				@foreach (ThemeConfig config in LoadedThemes)
				{
					<MudSelectItem Value="@config.Id">@config.Name</MudSelectItem>
				}
			</MudSelect>
		}
		else
		{
			<MudSelect Label="Select Theme" FullWidth="true" Value="@SelectedId" ValueChanged="(Guid id) => HandleThemeChange(id)">
				@foreach (ThemeConfig config in LoadedThemes)
				{
					<MudSelectItem Value="@config.Id">@config.Name</MudSelectItem>
				}
			</MudSelect>
		}
	}
	<MudButton Icon="@Icons.Material.Filled.DisplaySettings" Color="Color.Primary" Title="View Theme Settings Manager" OnClick="OpenThemeSettings" FullWidth="true">Theme Settings</MudButton>
</BUIDrawerPaper>

@code {
	private bool ShowThemeSelector => LoadedThemes.Count > 1;
	private Guid SelectedId => ThemeState.Current.Id;

	private List<ThemeConfig> LoadedThemes { get; set; } = new();

	protected override Task OnInitializedAsync()
	{
		ThemeState.SubscribeToDataChanges(ComponentId, HandleThemesUpdate);
		LoadedThemes = ThemeState.Themes;
		return base.OnInitializedAsync();
	}

	public override void Dispose()
	{
		ThemeState.UnsubscribeToDataChanges(ComponentId);
		base.Dispose();
	}

	private void HandleThemesUpdate()
	{
		InvokeAsync(() =>
		{
			LoadedThemes = ThemeState.Themes;
			FlipState = !FlipState;
			StateHasChanged();
		});
	}

	private void HandleThemeChange(Guid id)
	{
		foreach (ThemeConfig config in LoadedThemes)
		{
			if (config.Id != id) { continue; }
			ThemeState.Current = config;
			return;
		}
	}

	private void OpenThemeSettings()
	{
		DialogOptions options = new()
			{
				DisableBackdropClick = true
			};
		DialogService.Show<BUIThemeSettings>("Theme Settings Manager", options);
		AppState.ApplyChanges(() =>
		{
			AppState.SetData(AppStateDataTags.TitleBarRightDrawerOpen, false);
		});
	}
}
