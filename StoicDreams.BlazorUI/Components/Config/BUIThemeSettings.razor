@inherits BUICore

@inject IThemeState ThemeState

<BUIDialogConfirm OnSave="OnSave" OnCancel="OnCancel">
	<MudText Typo="Typo.h6">Theme Colors</MudText>
	<MudTextField Label="Name" @bind-Value="LoadedConfig.Name" MaxLength="50" HelperText="Change name and save to create new Theme." />
	<MudGrid>
		@foreach (ColorData item in ColorSettings)
		{
			<MudItem xs="12" sm="6" md="4" lg="3" xl="2">
				<MudColorPicker Label="@item.Name"
					Value="@item.HexValue"
					ValueChanged="(color => ApplyColorUpdate(color.Value, item))"
					DisableToolbar="false"
					/>
			</MudItem>
		}
	</MudGrid>
</BUIDialogConfirm>

@code {

	private List<ColorData> ColorSettings { get; set; } = new();
	private ThemeConfig LoadedConfig { get; set; } = new();
	private ThemeState State => (ThemeState)ThemeState;
	private ThemeConfig StartingConfig { get; set; } = new();

	protected override Task OnInitializedAsync()
	{
		LoadedConfig = ThemeState.Current;
		StartingConfig = LoadedConfig.Copy;
		BuildColorSetting();
		return base.OnInitializedAsync();
	}

	private void ApplyColorUpdate(string hexValue, ColorData color)
	{
		color.HexValue = hexValue;
		ThemeConfig config = LoadedConfig;
		Type configType = config.GetType();
		PropertyInfo? info = configType.GetProperty(color.Name);
		if (info == null) { return; }
		ColorData newValue = hexValue;
		info.SetValue(config, newValue);
		State.TriggerChange();
	}

	private void BuildColorSetting()
	{
		ThemeConfig config = LoadedConfig;
		Type configType = config.GetType();
		PropertyInfo[] configFields = configType.GetProperties();
		List<ColorData> colorSettings = new();
		foreach (PropertyInfo info in configFields)
		{
			if (info.PropertyType != typeof(ColorData)) { continue; }
			object? value = info.GetValue(config);
			if (value == null) { continue; }
			if (value is ColorData color)
			{
				colorSettings.Add(ColorData.Create(config.GetDisplay(info.Name), color));
			}
		}
		ColorSettings = colorSettings;
	}

	private void OnSave()
	{
		Snackbar.Add("Simulated Save!", Severity.Info);
	}

	private void OnCancel()
	{
		LoadedConfig.CopyValues(StartingConfig);
	}
}
