@implements IDisposable

@inject IAppOptions AppOptions
@inject IAppState AppState
@inject IJSRuntime JSRuntime
@inject IJsInterop JSInterop
@inject NavigationManager NavManager

<PageTitle>@AppTitle</PageTitle>

@ChildContent

@code {
	[Parameter]
	public RenderFragment? ChildContent { get; set; }

	private string AppTitle => AppOptions.TitleFormat
			.Replace("{AppName}", AppOptions.AppName)
			.Replace("{PageTitle}", "Page Title")
			;

	protected override async Task OnInitializedAsync()
	{
		if (ChildContent == null)
		{
			throw new NullReferenceException($"{this.GetType().FullName} is required to have child content.");
		}
		AppState.SubscribeToDataChanges(ComponentId, HandleDataChanges);
		await RunSetupFromOptions();
		await base.OnInitializedAsync();
	}

	public void Dispose()
	{
		AppState.UnsubscribeToDataChanges(ComponentId);
	}

	private void HandleDataChanges(IDictionary<string, bool> keys)
	{
		if (!keys.ContainsKey("PageTitle")) { return; }
		StateHasChanged();
	}

	private async ValueTask RunSetupFromOptions()
	{
		foreach (string file in AppOptions.CssFiles)
		{
			await JSInterop.AddCSSFile(file);
		}
		foreach (string file in AppOptions.JavascriptFiles)
		{
			await JSInterop.AddJSFile(file);
		}
		foreach (ElementDetail detail in AppOptions.HeadElements)
		{
			await JSInterop.AddElementToHead(detail.TagName, detail.Attributes);
		}
		foreach (ElementDetail detail in AppOptions.BodyElements)
		{
			await JSInterop.AddElementToBody(detail.TagName, detail.Attributes);
		}
	}

	private Guid ComponentId { get; } = Guid.NewGuid();
}
